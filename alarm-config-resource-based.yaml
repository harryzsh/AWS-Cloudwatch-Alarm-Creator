# Resource-Based Alarm Configuration
# Services: Kafka (MSK), ACM, ALB, Direct Connect
# All broker-level Kafka metrics use Metrics Insights SQL to aggregate across brokers
# One alarm per metric - _WARNING severity tier

services:
  kafka:
    name: MSK (Kafka)
    namespace: AWS/Kafka
    dimension_name: Cluster Name
    alarms:
      - metric: MaxOffsetLag
        threshold: 200000
        operator: GreaterThanThreshold
        description: Kafka消费者组最大偏移延迟 - 消费者落后生产者

      - metric: CpuUser
        threshold: 90
        operator: GreaterThanThreshold
        description: Kafka Broker CPU用户空间使用率

      - metric: HeapMemoryAfterGC
        threshold: 90
        operator: GreaterThanThreshold
        description: Kafka Broker GC后堆内存使用百分比

      - metric: KafkaDataLogsDiskUsed
        threshold: 75
        operator: GreaterThanThreshold
        description: Kafka数据日志磁盘使用率

      - metric: ActiveControllerCount
        threshold: 1
        operator: LessThanThreshold
        description: Kafka活跃控制器数量 - 应始终为1

  acm:
    name: ACM
    namespace: AWS/CertificateManager
    dimension_name: CertificateArn
    alarms:
      - metric: DaysToExpiry
        threshold: 30
        operator: LessThanOrEqualToThreshold
        description: ACM证书到期天数 - 证书即将过期

  alb:
    name: ALB
    namespace: AWS/ApplicationELB
    dimension_name: LoadBalancer
    alarms:
      - metric: UnHealthyHostCount
        threshold: 1
        operator: GreaterThanOrEqualToThreshold
        description: ALB后端不健康主机数量大于等于1

  directconnect:
    name: Direct Connect
    namespace: AWS/DX
    dimension_name: ConnectionId
    alarms:
      - metric: ConnectionState
        threshold: 1
        operator: LessThanThreshold
        description: Direct Connect连接状态 - 连接断开

      - metric: IngressBandwidthPercent
        math_expression: "m1/bandwidth*100"
        math_metrics:
          m1: ConnectionBpsIngress
        threshold: 90
        operator: GreaterThanThreshold
        description: Direct Connect入站带宽使用百分比
        bandwidth_parameter: true

      - metric: EgressBandwidthPercent
        math_expression: "m1/bandwidth*100"
        math_metrics:
          m1: ConnectionBpsEgress
        threshold: 90
        operator: GreaterThanThreshold
        description: Direct Connect出站带宽使用百分比
        bandwidth_parameter: true
